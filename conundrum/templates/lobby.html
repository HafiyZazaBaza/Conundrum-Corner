<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lobby - {{ lobby_code }}</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="lobby-container container">
    <header class="top-row">
      <h1 class="title">ðŸŽ² Lobby: <span id="lobby-code">{{ lobby_code }}</span></h1>
      <div class="top-actions">
        <button id="copy-btn" class="small-btn">Copy Code</button>
      </div>
    </header>

    <p class="you-line">
      You are: <strong id="you">{{ username }}</strong>
      {% if is_host %} <span class="host-badge-inline">host</span>{% endif %}
    </p>

    <main class="lobby-grid">
      <!-- Left: Players / Host controls -->
      <section class="card players-card">
        <div class="card-header">
          <strong>Players</strong>
          <span class="player-count" id="player-count">({{ lobby_data.get("players_count", 0) if lobby_data else '0' }})</span>
        </div>

        <ul id="users" class="players-list" aria-live="polite" style="margin-top:8px; padding-left:18px;"></ul>

        {% if is_host %}
        <div class="host-controls">
          <label for="game_mode" class="label-inline">Choose game mode</label>
          <select id="game_mode" class="select-control">
              <option value="reverse_guessing">Reverse Guessing</option>
              <option value="emoji_translation">Emoji Translation</option>
              <option value="bad_advice_hotline">Bad Advice Hotline</option>
              <option value="obviously_lies">Obviously Lies</option>
          </select>

          <label for="max_rounds" class="label-inline" style="margin-top:8px;">Max rounds</label>
          <input id="max_rounds" type="number" min="1" value="{{ lobby_data.max_rounds if lobby_data and lobby_data.max_rounds else 5 }}" class="small-input" />

          <div class="host-actions" style="margin-top:8px;">
            <button id="start-btn" class="small-btn">Start Game</button>
          </div>

          <!-- Next round control appears while game is active -->
          <div id="round-controls" style="margin-top:10px; display:none;">
            <div>Round: <span id="current-round">0</span> / <span id="max-rounds">0</span></div>
            <button id="next-round-btn" class="small-btn">Next Round</button>
          </div>
        </div>
        {% else %}
          <div class="waiting-note">Waiting for host to start the gameâ€¦</div>
          <div id="round-info" style="margin-top:8px; display:none;">
            Round: <span id="current-round-public">0</span> / <span id="max-rounds-public">0</span>
          </div>
        {% endif %}
      </section>

      <!-- Right: Chat -->
      <section class="card chat-card">
        <div class="card-header"><strong>Lobby Chat</strong></div>

        <div id="chat-box" class="messages" aria-live="polite" role="log"></div>

        <form id="chat-form" class="chat-form" style="margin-top:12px;">
          <input type="text" id="message" class="chat-input" placeholder="Type message..." autocomplete="off" />
          <button type="submit" class="small-btn">Send</button>
        </form>
      </section>
    </main>
  </div>

<script>
  const socket = io();
  const username = "{{ username|e }}";
  const lobbyCode = "{{ lobby_code|e }}";

  // Immediately join the lobby room on page load
  socket.emit("join_lobby", { username, lobbyCode });

  // Update players
  socket.on("lobby_update", data => {
    const usersEl = document.getElementById("users");
    usersEl.innerHTML = "";
    const players = data.players || [];
    players.forEach(u => {
      const li = document.createElement("li");
      li.className = "player-item";
      li.textContent = u;
      if (u === data.host) {
        const span = document.createElement("span");
        span.className = "host-badge";
        span.textContent = "host";
        li.appendChild(span);
      }
      usersEl.appendChild(li);
    });
    const countEl = document.getElementById("player-count");
    if (countEl) countEl.textContent = `(${players.length})`;
  });

  // Chat messages
  socket.on("receive_message", data => {
    const chatBox = document.getElementById("chat-box");
    const p = document.createElement("p");
    p.className = "message-line";
    p.innerHTML = `<b>${data.username}:</b> ${data.message}`;
    chatBox.appendChild(p);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // Errors
  socket.on("error_message", data => alert(data.message || "Error"));

  // When game starts â†’ redirect to play (server sends mode + round info)
  socket.on("game_started", data => {
    // ensure lobby UI shows round controls for host
    const maxRoundsSpan = document.getElementById("max-rounds");
    const currentRoundSpan = document.getElementById("current-round");
    const maxRoundsPub = document.getElementById("max-rounds-public");
    const currentRoundPub = document.getElementById("current-round-public");

    if (data.max_rounds) {
      if (maxRoundsSpan) maxRoundsSpan.textContent = data.max_rounds;
      if (maxRoundsPub) maxRoundsPub.textContent = data.max_rounds;
    }
    if (data.current_round) {
      if (currentRoundSpan) currentRoundSpan.textContent = data.current_round;
      if (currentRoundPub) currentRoundPub.textContent = data.current_round;
    }

    // show controls
    const rc = document.getElementById("round-controls");
    if (rc) rc.style.display = "block";
    const rip = document.getElementById("round-info");
    if (rip) rip.style.display = "block";

    // then redirect to the game page
    const target = `/games/play?lobby=${encodeURIComponent(lobbyCode)}&username=${encodeURIComponent(username)}&mode=${encodeURIComponent(data.mode)}`;
    window.location.href = target;
  });

  // Round updated
  socket.on("round_updated", data => {
    const currentRoundSpan = document.getElementById("current-round");
    const maxRoundsSpan = document.getElementById("max-rounds");
    const currentRoundPub = document.getElementById("current-round-public");
    const maxRoundsPub = document.getElementById("max-rounds-public");

    if (currentRoundSpan) currentRoundSpan.textContent = data.current_round;
    if (maxRoundsSpan) maxRoundsSpan.textContent = data.max_rounds;
    if (currentRoundPub) currentRoundPub.textContent = data.current_round;
    if (maxRoundsPub) maxRoundsPub.textContent = data.max_rounds;
  });

  // Game over
  socket.on("game_over", data => {
    alert("Game over! Final round: " + (data.final_round || ""));
    // hide controls
    const rc = document.getElementById("round-controls");
    if (rc) rc.style.display = "none";
  });

  // Send chat
  document.getElementById("chat-form").addEventListener("submit", e => {
    e.preventDefault();
    const input = document.getElementById("message");
    const msg = input.value.trim();
    if (!msg) return;
    socket.emit("send_message", { lobbyCode, username, message: msg });
    input.value = "";
    input.focus();
  });

  // Start game (host only)
  const startBtn = document.getElementById("start-btn");
  if (startBtn) {
    startBtn.addEventListener("click", () => {
      startBtn.disabled = true;
      const selectedMode = document.getElementById("game_mode").value;
      const maxRounds = parseInt(document.getElementById("max_rounds").value || "5", 10);
      socket.emit("start_game", { lobbyCode, username, mode: selectedMode, maxRounds });
    });
  }

  // Next round (host only)
  const nextBtn = document.getElementById("next-round-btn");
  if (nextBtn) {
    nextBtn.addEventListener("click", () => {
      nextBtn.disabled = true;
      socket.emit("next_round", { lobbyCode, username });
      // re-enable after a short debounce so host can't spam
      setTimeout(() => nextBtn.disabled = false, 600);
    });
  }

  // Copy code
  document.getElementById("copy-btn").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(lobbyCode);
      const btn = document.getElementById("copy-btn");
      btn.textContent = "Copied!";
      setTimeout(() => btn.textContent = "Copy Code", 1200);
    } catch (err) {
      alert("Copy failed");
    }
  });

  // Rejoin on reconnect
  socket.on("connect", () => socket.emit("join_lobby", { username, lobbyCode }));
</script>
</body>
</html>
